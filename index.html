<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoker Trainer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="container">
        <div class="points">0</div>
        <div class="boardbox">
            <div class="board"></div>
            <div class="habilities">
                <div class="normal">            
                    <div class="hability"></div>
                    <div class="hability"></div>
                    <div class="hability"></div>
                </div>
                <div class="invoke">R</div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

    <script>
        var boardWidth = 400,
            boardHeight = 400,
            boxSize = 100;

        var level = 1,
            points = 0;

        var timeoutHandler;

        var spells = {
            QQQ: 'cold',
            QQW: 'ghost',
            QWW: 'tornado',
            WWW: 'emp',
            EWW: 'alacrity',
            EQW: 'blast',
            EEW: 'meteor',
            EQQ: 'wall',
            EEQ: 'spirit',
            EEE: 'sun'
        };
        var spellKeys = Object.keys(spells);

        function createFallBox() {

            var nextTime = 2500 / level;
            timeoutHandler = setTimeout(function() {
                var spellKey = spellKeys[Math.floor(Math.random() * spellKeys.length)];
                var spell = spells[spellKey];
                var $box = $('<div class="box ' + spell + '">' + spell + '</div>').appendTo('.board');
                var top = '-' + boxSize + 'px';
                var left = Math.floor(boxSize * (Math.random() * 3)) + 'px';
                $box.css({top: top, left: left}).animate({top: boardHeight + 'px'}, 10000 / level, 'linear', function() {
                    $box.remove();
                });
                createFallBox();
            }, nextTime);

        }

        createFallBox();

        $(document).on('keydown', function(e) {
            var code = e.keyCode || e.which;
            //console.log(code);
            var letter = '';
            switch (code) {
                case 81:
                    letter = 'Q';
                    break;
                case 87:
                    letter = 'W';
                    break;
                case 69:
                    letter = 'E';
                    break;
                case 82:
                    letter = 'R';
                    break;
            }
            if (letter) {
                if (letter == 'R') {
                    var letters = $($('.normal').html()).text();
                    if (letters.length == 3) {
                        // sort letters
                        var spellKey = letters.split('').sort().join('');
                        var spell = spells[spellKey];
                        var match = $('.box.' + spell).first();
                        if (match.length == 1) {
                            level += 0.01;
                            points += 1;
                            $('.points').text(points);
                            match.finish();
                        }
                        //console.log(spell);
                    }
                } else {
                    if ($('.hability').length == 3) {
                        $('.hability').first().remove();
                    }
                    $('<div class="hability ' + letter + '">' + letter + '</div>').appendTo('.habilities .normal');
                }
            }
        });

    </script>
</body>
</html>